<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Panel del L√≠der</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            neonCyan: '#00f2ff',
            neonMagenta: '#ff00e5',
            neonPurple: '#bc13fe',
            cyberDark: '#020205',
          }
        }
      }
    }
  </script>
</head>

<body class="bg-cyberDark min-h-screen text-gray-100 font-sans relative overflow-x-hidden">
  <div class="fixed inset-0 pointer-events-none z-0">
    <div class="absolute top-[-10%] right-[-10%] w-[40%] h-[40%] bg-neonCyan/5 blur-[120px] rounded-full"></div>
    <div class="absolute bottom-[-10%] left-[-10%] w-[40%] h-[40%] bg-neonMagenta/5 blur-[120px] rounded-full"></div>
  </div>

  <div class="max-w-4xl mx-auto p-4 sm:p-8 relative z-10">
    <div
      class="bg-black/60 backdrop-blur-2xl border border-white/10 shadow-[0_0_50px_rgba(0,242,255,0.1)] rounded-3xl p-6 relative overflow-hidden">
      <div
        class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-neonCyan to-transparent opacity-50">
      </div>
      <h2 class="text-3xl font-black italic tracking-tighter">
        <span
          class="text-transparent bg-clip-text bg-gradient-to-r from-neonCyan to-neonPurple drop-shadow-[0_0_10px_rgba(0,242,255,0.4)]">üëë
          PANEL CENTRAL</span>
      </h2>
      <p class="text-[10px] uppercase tracking-[0.3em] font-bold text-gray-500 mt-1">Control de Red y Protocolos de
        Juego</p>

      <div class="mt-6 flex items-center gap-3 bg-white/5 p-3 rounded-xl border border-white/10 backdrop-blur-md">
        <input type="checkbox" id="auto-advance" class="w-5 h-5 accent-neonCyan">
        <label for="auto-advance"
          class="text-xs font-bold uppercase tracking-widest text-gray-400 cursor-pointer hover:text-neonCyan transition-colors">Modo
          Avance Autom√°tico</label>
      </div>

      <div class="mt-6 flex flex-col sm:flex-row gap-3">
        <input type="password" id="clave" placeholder="C√≥digo de Acceso Admin"
          class="w-full sm:flex-1 px-4 py-4 rounded-xl bg-white/5 border border-white/10 focus:border-neonCyan focus:ring-1 focus:ring-neonCyan/50 focus:outline-none transition-all duration-300 text-gray-100 placeholder:text-gray-600">
        <button id="btn-entrar"
          class="px-8 py-4 rounded-xl bg-neonCyan text-black font-black uppercase tracking-widest hover:bg-white hover:shadow-[0_0_20px_#00f2ff] transition-all active:scale-95">Ingresar</button>
      </div>

      <p id="admin-status" class="text-sm text-gray-200/80 mt-3"></p>
    </div>

    <div id="panel" class="hidden mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div
        class="lg:col-span-2 bg-black/60 backdrop-blur-2xl border border-white/10 shadow-2xl rounded-3xl p-6 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-2 h-full bg-neonCyan/20"></div>
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <h3 class="text-xl font-bold">Equipos</h3>
          <div class="flex gap-2 flex-wrap">
            <button id="btn-next-question"
              class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-gray-900 font-extrabold ring-2 ring-emerald-300/30">Siguiente
              Pregunta</button>
            <button id="btn-end-game"
              class="px-4 py-2 rounded-lg bg-yellow-400 hover:bg-yellow-300 text-gray-900 font-extrabold ring-2 ring-yellow-200/30">Terminar
              juego</button>
            <button id="btn-reset-points"
              class="px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-extrabold ring-2 ring-cyan-300/30">Restablecer
              puntos</button>
            <button id="btn-reset-game"
              class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-extrabold ring-2 ring-indigo-300/30">Reiniciar
              Cuestionario</button>
            <button id="btn-wait-groups"
              class="px-4 py-2 rounded-lg bg-neonPurple hover:bg-fuchsia-500 text-black font-extrabold ring-2 ring-fuchsia-300/30">Esperar
              Grupos</button>
            <button id="btn-delete-teams"
              class="px-4 py-2 rounded-lg bg-rose-500 hover:bg-rose-400 text-gray-900 font-extrabold ring-2 ring-rose-300/30">Borrar
              equipos</button>
            <button id="btn-clear-report"
              class="px-4 py-2 rounded-lg bg-gray-500 hover:bg-gray-400 text-gray-900 font-extrabold ring-2 ring-gray-300/30">Limpiar
              Reporte</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="bg-white/5 rounded-2xl p-4 border border-white/5 backdrop-blur-md">
            <p class="text-gray-500 text-[9px] uppercase tracking-widest font-black">Fase Actual</p>
            <p id="current-question"
              class="text-2xl font-black text-neonCyan drop-shadow-[0_0_5px_rgba(0,242,255,0.3)]">‚Äî</p>
          </div>
          <div class="bg-white/5 rounded-2xl p-4 border border-white/5 backdrop-blur-md">
            <p class="text-gray-500 text-[9px] uppercase tracking-widest font-black">Nodos Activos</p>
            <p id="team-count" class="text-2xl font-black text-neonCyan drop-shadow-[0_0_5px_rgba(0,242,255,0.3)]">0</p>
          </div>
          <div class="bg-white/5 rounded-2xl p-4 border border-white/5 backdrop-blur-md">
            <p class="text-gray-500 text-[9px] uppercase tracking-widest font-black">Estatus Red</p>
            <p id="panel-status" class="text-xs font-bold text-gray-300 uppercase mt-1">Standby</p>
          </div>
        </div>

        <div class="mt-5 overflow-x-auto">
          <table class="w-full text-left border-separate" style="border-spacing: 0 10px;">
            <thead>
              <tr class="text-gray-400 text-xs">
                <th class="px-4">Equipo</th>
                <th class="px-4">Puntos</th>
                <th class="px-4">Penalizaciones</th>
              </tr>
            </thead>
            <tbody id="teams-table"></tbody>
          </table>
        </div>

        <div class="mt-8">
          <h4 class="text-lg font-bold">Respuestas (pregunta actual)</h4>
          <p class="text-gray-300 text-sm mt-1">Se actualiza en vivo cuando los equipos contestan.</p>
          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-left border-separate" style="border-spacing: 0 10px;">
              <thead>
                <tr class="text-gray-400 text-xs">
                  <th class="px-4">Equipo</th>
                  <th class="px-4">Respuesta</th>
                  <th class="px-4">Correcta</th>
                  <th class="px-4">Puntos</th>
                </tr>
              </thead>
              <tbody id="answers-table"></tbody>
            </table>
          </div>
        </div>

        <div id="final-report" class="hidden mt-10">
          <div class="flex items-center justify-between gap-4 flex-wrap">
            <h4 class="text-lg font-bold">Reporte final</h4>
            <span id="final-report-status" class="text-sm text-gray-300"></span>
          </div>
          <p class="text-gray-300 text-sm mt-1">Puntos + correctas/incorrectas/timeout y % de conocimiento.</p>
          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-left border-separate" style="border-spacing: 0 10px;">
              <thead>
                <tr class="text-gray-400 text-xs">
                  <th class="px-4">Equipo</th>
                  <th class="px-4">Puntos</th>
                  <th class="px-4">Buenas</th>
                  <th class="px-4">Malas</th>
                  <th class="px-4">Sin responder</th>
                  <th class="px-4">% Eficiencia</th>
                  <th class="px-4">Tiempo Prom.</th>
                  <th class="px-4">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="final-report-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div
        class="bg-black/60 backdrop-blur-2xl border border-white/10 shadow-2xl rounded-3xl p-6 relative overflow-hidden h-fit">
        <h3 class="text-xs font-black uppercase tracking-[0.2em] text-neonPurple/80 mb-4 flex items-center gap-2">
          <span class="w-1.5 h-1.5 rounded-full bg-neonPurple shadow-[0_0_10px_#bc13fe]"></span>
          Base de Datos
        </h3>
        <p class="text-[10px] text-gray-500 mb-6 italic leading-relaxed">Protocolos de verificaci√≥n y base teol√≥gica.
        </p>
        <div id="questions" class="mt-4 space-y-3 custom-scrollbar overflow-y-auto max-h-[600px]"></div>
      </div>
    </div>
  </div>

  <!-- Modal de Detalle de Respuestas -->
  <div id="modal-detalle"
    class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div
      class="bg-[#1a1409] border border-amber-500/30 w-full max-w-2xl max-h-[80vh] overflow-y-auto rounded-2xl p-6 shadow-2xl">
      <div class="flex justify-between items-center mb-4 border-b border-amber-500/20 pb-2">
        <h3 id="modal-titulo" class="text-xl font-bold text-amber-200">Detalle de Equipo</h3>
        <button onclick="cerrarModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="modal-contenido" class="space-y-4">
        <!-- Detalles de respuestas aqu√≠ -->
      </div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      collectionGroup,
      query,
      orderBy,
      onSnapshot,
      where,
      getDocs,
      writeBatch,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC8xL6OM_ff7LqFJj_P87d9wVR-BT8OJsE",
      authDomain: "dinamica-en-tiempo-real.firebaseapp.com",
      projectId: "dinamica-en-tiempo-real",
      storageBucket: "dinamica-en-tiempo-real.firebasestorage.app",
      messagingSenderId: "1096669474654",
      appId: "1:1096669474654:web:0348238823f2a0cbdea9cf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const GAME_ID = "main-game";
    const gameRef = doc(db, `games/${GAME_ID}`);
    const teamsRef = collection(db, `games/${GAME_ID}/teams`);

    const adminRef = doc(db, "config", "admin");

    const panel = document.getElementById('panel');
    const adminStatus = document.getElementById('admin-status');
    const panelStatus = document.getElementById('panel-status');
    const btnEntrar = document.getElementById('btn-entrar');
    const btnNextQuestion = document.getElementById('btn-next-question');
    const btnEndGame = document.getElementById('btn-end-game');
    const btnResetPoints = document.getElementById('btn-reset-points');
    const btnDeleteTeams = document.getElementById('btn-delete-teams');
    const btnResetGame = document.getElementById('btn-reset-game');
    const btnWaitGroups = document.getElementById('btn-wait-groups');
    const teamsTable = document.getElementById('teams-table');
    const answersTable = document.getElementById('answers-table');
    const teamCount = document.getElementById('team-count');
    const currentQuestion = document.getElementById('current-question');
    const questionsEl = document.getElementById('questions');
    const finalReport = document.getElementById('final-report');
    const finalReportStatus = document.getElementById('final-report-status');
    const finalReportTable = document.getElementById('final-report-table');
    const autoAdvanceCheck = document.getElementById('auto-advance');
    const btnClearReport = document.getElementById('btn-clear-report');

    let currentQuestionIndex = -1;
    let registeredTeamsCount = 0;
    let unsubscribeAnswers = null;
    let autoAdvanceCooldown = false;

    const preguntas = [
      {
        pregunta: "Seg√∫n Lucas 3:8, ¬øqu√© prueba que una persona se ha arrepentido de verdad y ha vuelto a Dios?",
        opciones: ["Realizar sacrificios y ofrendas", "Demostrarlo con su forma de vivir", "Pertenecer a una familia con linaje espiritual", "Decir 'estamos a salvo por Abraham'"],
        correcta: 1,
        explicacion: "El arrepentimiento real produce frutos; es un cambio de direcci√≥n que se nota en la conducta, no solo en palabras o herencia espiritual."
      },
      {
        pregunta: "¬øA qu√© se refiere el concepto de que 'Dios no tiene nietos'?",
        opciones: ["A que la fe no se hereda; cada uno necesita un encuentro personal", "A que Dios solo ama a sus hijos biol√≥gicos", "A que los ancianos no pueden conocer a Dios de verdad", "A que la descendencia de Abraham fue un error"],
        correcta: 0,
        explicacion: "Nadie nace siendo cristiano por sus padres; la salvaci√≥n es una relaci√≥n individual y una decisi√≥n personal de cada ser humano."
      },
      {
        pregunta: "En Lucas 10:41-42, ¬øcu√°l fue la '√∫nica cosa' necesaria que Mar√≠a descubri√≥ y Marta ignor√≥?",
        opciones: ["Servir con excelencia a los invitados", "La preocupaci√≥n por los detalles del altar", "Estar en Su presencia y escuchar Su palabra", "Ayudar a los pobres de la aldea"],
        correcta: 2,
        explicacion: "El servicio es bueno, pero estar a los pies de Jes√∫s escuchando Su voz es la prioridad que sustenta todo lo dem√°s."
      },
      {
        pregunta: "¬øQu√© sucede cuando el servicio a Dios carece de una relaci√≥n personal?",
        opciones: ["Se santifica por el esfuerzo realizado", "Se vuelve m√°s eficiente por la disciplina", "Te garantiza un lugar en el cielo", "Se convierte en rutina y la rutina en vac√≠o"],
        correcta: 3,
        explicacion: "Las actividades religiosas sin amor e intimidad con Dios se vuelven mec√°nicas, aburridas y eventualmente nos dejan vac√≠os."
      },
      {
        pregunta: "Seg√∫n Efesios 2:8-9, ¬øpor qu√© raz√≥n ninguno de nosotros puede jactarse de ser salvo?",
        opciones: ["Porque la salvaci√≥n es un regalo de Dios, no por m√©ritos", "Porque la salvaci√≥n es un premio individual", "Porque el orgullo es un pecado menor", "Porque las obras buenas son opcionales"],
        correcta: 0,
        explicacion: "La salvaci√≥n es por GRACIA (regalo inmerecido). No la ganamos por portarnos bien, para que el orgullo no tenga lugar."
      },
      {
        pregunta: "En G√©nesis 32, ¬øcu√°l fue el prop√≥sito real del quebrantamiento de Jacob al luchar con el √°ngel?",
        opciones: ["Castigarlo por enga√±ar a su hermano Esa√∫", "Transformar su identidad de 'suplantador' a Israel", "Demostrar que el √°ngel era m√°s fuerte que √©l", "Quitarle sus riquezas acumuladas"],
        correcta: 1,
        explicacion: "Jacob necesitaba dejar de confiar en sus fuerzas y sus ma√±as ('suplantador') para rendirse a Dios y recibir una nueva identidad ('Israel')."
      },
      {
        pregunta: "El 'Heme aqu√≠' de Samuel, a diferencia de los hijos de El√≠, representaba:",
        opciones: ["Que √©l era el m√°s preparado teol√≥gicamente", "Que no ten√≠a otros compromisos en el templo", "Una respuesta autom√°tica por miedo al castigo", "Una actitud de obediencia radical y honra desde el coraz√≥n"],
        correcta: 3,
        explicacion: "La honra no es un cargo; es una disposici√≥n del coraz√≥n que dice 'estoy dispuesto a escucharte y hacer lo que digas'."
      },
      {
        pregunta: "Seg√∫n las notas, ¬øcu√°l es la ra√≠z com√∫n de todas las cosas 'disfrazadas de honra'?",
        opciones: ["El orgullo disfrazado que se resiste a renunciar al 'yo'", "La falta de recursos econ√≥micos", "La falta de tiempo para orar", "La timidez de los creyentes"],
        correcta: 0,
        explicacion: "A veces servimos o damos para ser vistos o sentirnos bien, sin realmente rendir nuestro orgullo al se√±or√≠o de Cristo."
      },
      {
        pregunta: "Seg√∫n Mateo 16:24, ¬øcu√°l es el requisito indispensable para ser un seguidor de Jes√∫s?",
        opciones: ["Ganar el mundo entero primero", "Tener una reputaci√≥n intachable en la sociedad", "Negarse a s√≠ mismo, tomar su cruz y seguirlo", "Cumplir con todas las tradiciones heredadas"],
        correcta: 2,
        explicacion: "Seguir a Jes√∫s requiere morir a nuestros propios deseos ('tomar la cruz') para que Su voluntad sea lo primero en nuestra vida."
      },
      {
        pregunta: "Basado en 1 Juan 4:18, quien a√∫n tiene miedo al castigo demuestra que:",
        opciones: ["Es una persona muy prudente", "Tiene un temor santo y necesario", "No ha experimentado plenamente el perfecto amor de Dios", "Est√° a un paso de la perfecci√≥n"],
        correcta: 2,
        explicacion: "El amor de Dios es perfecto y nos da seguridad. Si servimos por miedo al castigo, a√∫n no hemos entendido cu√°n profundamente nos ama."
      },
      {
        pregunta: "¬øCu√°l es la diferencia fundamental entre los actos fingidos y los frutos del coraz√≥n?",
        opciones: ["Los actos son siempre m√°s visibles", "Los actos pueden fingirse, pero los frutos revelan el coraz√≥n real", "Los frutos solo aparecen en personas perfectas", "No hay diferencia si la intenci√≥n es buena"],
        correcta: 1,
        explicacion: "Cualquiera puede actuar bien por un rato, pero el fruto (amor, gozo, paz) es lo que sale naturalmente cuando Dios vive en nosotros."
      },
      {
        pregunta: "¬øPor qu√© el amor es descrito como el elemento que 'mata el orgullo'?",
        opciones: ["Porque el amor es una emoci√≥n pasajera", "Porque te hace sentir superior a los que no aman", "Porque elimina la necesidad de tener una relaci√≥n", "Porque te lleva a desear tanto a Dios que ya no quieres pecar"],
        correcta: 3,
        explicacion: "Cuando amamos a Dios sobre todas las cosas, nuestro deseo de agradarle supera nuestro deseo de satisfacernos a nosotros mismos o al pecado."
      },
      {
        pregunta: "Seg√∫n el texto, ¬øpor qu√© ya no necesitamos de intermediarios humanos para llegar al Padre?",
        opciones: ["Porque Jes√∫s nos dio acceso directo al trono de la gracia", "Porque ahora somos descendientes biol√≥gicos de Abraham", "Porque las piedras pueden convertirse en hijos", "Porque el servicio en el altar nos santifica"],
        correcta: 0,
        explicacion: "La muerte de Jes√∫s rompi√≥ el velo. Depender de intermediarios humanos puede volver nuestra fe una tradici√≥n lejana en lugar de una relaci√≥n viva."
      },
      {
        pregunta: "¬øCu√°l es el punto de partida para que Dios transforme nuestra vida seg√∫n la experiencia de 'rendirse'?",
        opciones: ["Hacer mil cosas para llamar Su atenci√≥n", "Reconocer que sin √âl no somos nada y decir 'Heme aqu√≠'", "Prepararse teol√≥gicamente como los hijos de El√≠", "Forzar un encuentro espiritual a trav√©s del esfuerzo"],
        correcta: 1,
        explicacion: "No se trata de cu√°nto hagamos (Marta), sino de reconocer nuestra total dependencia y estar dispuestos a escuchar con humildad (Samuel)."
      },
      {
        pregunta: "¬øPor qu√© Jacob, siendo nieto de Abraham, necesit√≥ ser quebrantado por Dios en Peniel?",
        opciones: ["Para ganar la pelea contra el √°ngel", "Para que su fe dejara de ser heredada y tuviera un encuentro personal", "Para poder heredar las riquezas de su abuelo", "Porque Dios quer√≠a castigarlo por sus pecados pasados"],
        correcta: 1,
        explicacion: "Ser 'nieto' (heredar la fe) no basta. Jacob necesitaba su propio encuentro para que su identidad fuera transformada de suplantador a pr√≠ncipe."
      },
      {
        pregunta: "Seg√∫n 1 Juan 4:18, ¬øqu√© revela el hecho de que alguien sirva a Dios por miedo al castigo?",
        opciones: ["Que es una persona muy obediente", "Que ha alcanzado el amor perfecto", "Que no ha experimentado plenamente el perfecto amor de Dios", "Que tiene una fe m√°s s√≥lida que los dem√°s"],
        correcta: 2,
        explicacion: "El servicio por miedo es esclavitud. El amor perfecto expulsa el temor, llev√°ndonos a servir por gratitud y no por terror a las consecuencias."
      },
      {
        pregunta: "¬øQu√© significa realmente 'soltar el √∫ltimo √≠dolo' para alcanzar una vida de honra?",
        opciones: ["Abandonar nuestra propia manera de vivir y lo que nos estanca", "Dejar de ir a la iglesia por un tiempo para pensar", "Tratar de ganar el mundo entero con m√©ritos propios", "Aferrarnos a la vida para no perder la salvaci√≥n"],
        correcta: 0,
        explicacion: "La honra requiere negarse a s√≠ mismo (Mateo 16:24) y soltar aquello que, aunque nos guste, sabemos que impide nuestra entrega total a Cristo."
      }
    ];

    function setStatus(text) {
      panelStatus.textContent = text;
    }

    function setFinalReportStatus(text) {
      finalReportStatus.textContent = text;
    }

    function renderFinalRow({ teamId, points, correct, wrong, timeout, knowledgePercent, avgTime }) {
      const tr = document.createElement('tr');
      tr.className = 'bg-white/5 border border-white/5 transition-all hover:bg-white/10';

      const tdTeam = document.createElement('td');
      tdTeam.className = 'px-4 py-4 rounded-l-2xl font-bold text-sm';
      tdTeam.textContent = teamId;

      const tdPoints = document.createElement('td');
      tdPoints.className = 'px-4 py-4 font-black text-neonCyan drop-shadow-[0_0_5px_rgba(0,242,255,0.3)]';
      tdPoints.textContent = String(points ?? 0);

      const tdC = document.createElement('td');
      tdC.className = 'px-4 py-4 text-emerald-400 font-bold';
      tdC.innerHTML = `<span class="bg-emerald-500/10 px-2 py-1 rounded-lg">${correct}</span>`;

      const tdW = document.createElement('td');
      tdW.className = 'px-4 py-4 text-rose-400 font-bold';
      tdW.innerHTML = `<span class="bg-rose-500/10 px-2 py-1 rounded-lg">${wrong}</span>`;

      const tdT = document.createElement('td');
      tdT.className = 'px-4 py-4 text-orange-400 font-bold';
      tdT.innerHTML = `<span class="bg-orange-500/10 px-2 py-1 rounded-lg">${timeout}</span>`;

      const tdP = document.createElement('td');
      tdP.className = 'px-4 py-4 font-black text-gray-300';
      tdP.textContent = `${knowledgePercent}%`;

      const tdTime = document.createElement('td');
      tdTime.className = 'px-4 py-4 font-black text-neonCyan/70 text-xs';
      tdTime.textContent = `${avgTime}s`;

      const tdAction = document.createElement('td');
      tdAction.className = 'px-4 py-4 rounded-r-2xl';
      const btn = document.createElement('button');
      btn.innerText = 'DETALLES';
      btn.className = 'text-[9px] font-black tracking-widest bg-white/5 hover:bg-white/10 border border-white/10 hover:border-neonCyan hover:text-neonCyan px-3 py-2 rounded-xl transition-all';
      btn.onclick = () => verDetalleEquipo(teamId);
      tdAction.appendChild(btn);

      tr.appendChild(tdTeam);
      tr.appendChild(tdPoints);
      tr.appendChild(tdC);
      tr.appendChild(tdW);
      tr.appendChild(tdT);
      tr.appendChild(tdP);
      tr.appendChild(tdTime);
      tr.appendChild(tdAction);
      finalReportTable.appendChild(tr);
    }

    async function finishGame() {
      if (!confirm('¬øTerminar el juego? Esto mostrar√° el reporte final.')) return;

      setStatus('Terminando juego...');
      finalReport.classList.remove('hidden');
      finalReportTable.innerHTML = '';
      setFinalReportStatus('Calculando...');

      try {
        await setDoc(gameRef, { ended: true, endedAt: serverTimestamp(), currentQuestionIndex: -1, questionStartedAt: null }, { merge: true });
      } catch (err) {
        console.error(err);
        setStatus('No se pudo marcar terminado (posible error de permisos en Firestore).');
        setFinalReportStatus('Error marcando terminado.');
        return;
      }

      try {
        const teamsSnap = await getDocs(teamsRef);
        const totalQuestions = preguntas.length;

        for (const teamDoc of teamsSnap.docs) {
          const teamId = teamDoc.id;
          const teamData = teamDoc.data();

          let correct = 0;
          let wrong = 0;
          let timeout = 0;

          const answersRef = collection(db, `games/${GAME_ID}/teams/${teamId}/answers`);
          const answersSnap = await getDocs(answersRef);
          answersSnap.forEach((a) => {
            const ad = a.data();
            if (ad?.timeout) {
              timeout += 1;
              return;
            }
            if (ad?.isCorrect) correct += 1;
            else wrong += 1;
          });

          const knowledgePercent = totalQuestions > 0 ? Math.round((correct / totalQuestions) * 100) : 0;
          const totalAnswered = correct + wrong;
          const avgTime = totalAnswered > 0 ? (teamData.totalTimeSpent / totalAnswered).toFixed(1) : '0';

          renderFinalRow({
            teamId,
            points: teamData?.points ?? 0,
            correct,
            wrong,
            timeout,
            knowledgePercent,
            avgTime
          });

          // Guardar resumen en el doc del equipo para que quede persistente
          try {
            await setDoc(teamDoc.ref, {
              stats: {
                totalQuestions,
                correct,
                wrong,
                timeout,
                knowledgePercent,
                updatedAt: serverTimestamp()
              }
            }, { merge: true });
          } catch (err) {
            console.error(err);
          }
        }

        setStatus('Juego terminado.');
        setFinalReportStatus('Listo.');
      } catch (err) {
        console.error(err);
        setStatus('Juego terminado, pero fall√≥ el c√°lculo del reporte.');
        setFinalReportStatus('Error calculando reporte.');
      }
    }

    function renderAnswersEmpty(message) {
      answersTable.innerHTML = '';
      const tr = document.createElement('tr');
      tr.className = 'bg-white/5 border border-white/5';
      const td = document.createElement('td');
      td.colSpan = 4;
      td.className = 'px-4 py-6 rounded-2xl text-gray-500 text-xs text-center italic tracking-widest';
      td.textContent = message;
      tr.appendChild(td);
      answersTable.appendChild(tr);
    }

    function listenAnswersForQuestion(index) {
      if (unsubscribeAnswers) {
        unsubscribeAnswers();
        unsubscribeAnswers = null;
      }

      if (typeof index !== 'number' || index < 0) {
        renderAnswersEmpty('Sin pregunta activa.');
        return;
      }

      renderAnswersEmpty('Esperando respuestas...');

      const answersQuery = query(
        collectionGroup(db, 'answers'),
        where('questionIndex', '==', index)
      );

      unsubscribeAnswers = onSnapshot(answersQuery, (snap) => {
        answersTable.innerHTML = '';
        if (snap.empty) {
          renderAnswersEmpty('Esperando respuestas...');
          return;
        }

        let answersCount = 0;
        snap.forEach((d) => {
          answersCount++;
          const data = d.data();
          const teamId = d.ref.parent?.parent?.id ?? '‚Äî';
          const selectedLetter = typeof data.selectedIndex === 'number' ? String.fromCharCode(65 + data.selectedIndex) : '‚Äî';
          const correctLetter = typeof data.correctIndex === 'number' ? String.fromCharCode(65 + data.correctIndex) : '‚Äî';
          const isCorrect = !!data.isCorrect;

          const tr = document.createElement('tr');
          tr.className = 'bg-white/5 border border-white/5 hover:bg-white/10 transition-all';

          const tdTeam = document.createElement('td');
          tdTeam.className = 'px-4 py-4 rounded-l-2xl font-bold text-sm';
          tdTeam.textContent = teamId;

          const tdSel = document.createElement('td');
          tdSel.className = 'px-4 py-4 font-black';
          tdSel.textContent = selectedLetter;

          const tdCorrect = document.createElement('td');
          tdCorrect.className = `px-4 py-4 font-black ${isCorrect ? 'text-neonCyan' : 'text-neonMagenta shadow-[inset_0_0_10px_rgba(255,0,229,0.1)]'}`;
          tdCorrect.textContent = correctLetter;

          const tdPoints = document.createElement('td');
          tdPoints.className = 'px-4 py-4 rounded-r-2xl font-black text-gray-400';
          tdPoints.textContent = String(data.pointsChange ?? '‚Äî');

          tr.appendChild(tdTeam);
          tr.appendChild(tdSel);
          tr.appendChild(tdCorrect);
          tr.appendChild(tdPoints);
          answersTable.appendChild(tr);
        });

        // L√≥gica de avance autom√°tico
        if (autoAdvanceCheck.checked && !autoAdvanceCooldown && registeredTeamsCount > 0 && answersCount >= registeredTeamsCount) {
          triggerAutoAdvance();
        }
      }, (err) => {
        console.error(err);
        if (err?.code === 'permission-denied') {
          renderAnswersEmpty('Sin permisos para leer respuestas (Firestore).');
        } else {
          renderAnswersEmpty('Error leyendo respuestas.');
        }
      });
    }

    function renderQuestions() {
      questionsEl.innerHTML = '';
      preguntas.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-white/5 border border-white/5 rounded-2xl p-5 hover:border-neonCyan/20 transition-all group';

        const header = document.createElement('div');
        header.className = 'flex items-start justify-between gap-3';

        const title = document.createElement('div');
        title.className = 'text-sm font-medium leading-relaxed group-hover:text-gray-100 transition-colors';
        title.innerHTML = `<span class="text-neonCyan font-black mr-2">#${idx + 1}</span> ${q.pregunta}`;

        const toggleQuestion = document.createElement('button');
        toggleQuestion.className = 'shrink-0 text-[10px] font-black tracking-widest bg-white/5 border border-white/10 px-3 py-2 rounded-xl hover:bg-neonCyan hover:text-black transition-all';
        toggleQuestion.textContent = 'LISTA';

        header.appendChild(title);
        header.appendChild(toggleQuestion);

        const options = document.createElement('div');
        options.className = 'mt-3 space-y-1 text-sm text-gray-200';
        q.opciones.forEach((opt, i) => {
          const line = document.createElement('div');
          line.textContent = `${String.fromCharCode(65 + i)}) ${opt}`;
          options.appendChild(line);
        });

        const footer = document.createElement('div');
        footer.className = 'mt-4 flex items-center justify-between gap-3';

        const answer = document.createElement('div');
        answer.className = 'text-sm text-green-300 hidden';
        answer.textContent = `Correcta: ${String.fromCharCode(65 + q.correcta)} ) ${q.opciones[q.correcta]}`;

        const toggle = document.createElement('button');
        toggle.className = 'px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 border border-gray-700 font-bold';
        toggle.textContent = 'üëÅÔ∏è';
        toggle.addEventListener('click', () => {
          answer.classList.toggle('hidden');
        });

        footer.appendChild(answer);
        footer.appendChild(toggle);

        const content = document.createElement('div');
        content.className = 'hidden';
        content.appendChild(options);
        content.appendChild(footer);

        toggleQuestion.addEventListener('click', () => {
          const willShow = content.classList.contains('hidden');
          content.classList.toggle('hidden');
          toggleQuestion.textContent = willShow ? 'Ocultar' : 'Mostrar';
          if (!willShow) {
            answer.classList.add('hidden');
          }
        });

        card.appendChild(header);
        card.appendChild(content);
        questionsEl.appendChild(card);
      });
    }

    async function entrar() {
      adminStatus.textContent = '';
      const claveIngresada = document.getElementById('clave').value;
      let snap;
      try {
        snap = await getDoc(adminRef);
      } catch (err) {
        console.error(err);
        adminStatus.textContent = 'Error leyendo la clave (posible error de permisos en Firestore).';
        return;
      }

      if (snap.exists() && snap.data().clave === claveIngresada) {
        panel.classList.remove('hidden');
        adminStatus.textContent = 'Acceso concedido.';
        try {
          await setDoc(gameRef, { currentQuestionIndex: -1, questionStartedAt: null, ended: false, endedAt: null }, { merge: true });
        } catch (err) {
          console.error(err);
        }
        escuchar();
        renderQuestions();
      } else {
        adminStatus.textContent = 'Clave incorrecta.';
      }
    }

    btnEntrar.addEventListener('click', entrar);

    function escuchar() {
      const teamsQuery = query(teamsRef, orderBy('points', 'desc'));

      onSnapshot(gameRef, (snap) => {
        if (!snap.exists()) {
          currentQuestion.textContent = '‚Äî';
          return;
        }
        const ended = !!snap.data().ended;
        if (ended) {
          currentQuestion.textContent = 'Terminado';
          finalReport.classList.remove('hidden');
        }
        const idx = snap.data().currentQuestionIndex;
        currentQuestionIndex = typeof idx === 'number' ? idx : -1;
        if (typeof idx === 'number' && idx >= 0) {
          currentQuestion.textContent = `#${idx + 1}`;
        } else {
          if (!ended) currentQuestion.textContent = 'No iniciada';
        }

        listenAnswersForQuestion(currentQuestionIndex);
      }, (err) => {
        console.error(err);
        currentQuestion.textContent = '‚Äî';
      });

      onSnapshot(teamsQuery, (snap) => {
        registeredTeamsCount = snap.size;
        teamCount.textContent = registeredTeamsCount;
        teamsTable.innerHTML = '';
        snap.forEach((d, index) => {
          const team = d.data();
          const tr = document.createElement('tr');
          tr.className = 'bg-white/5 border border-white/5 hover:bg-white/10 transition-all';

          const tdName = document.createElement('td');
          tdName.className = 'px-4 py-4 rounded-l-2xl font-bold text-sm';
          tdName.innerHTML = `<span class="text-gray-600 mr-2 text-xs">#${index + 1}</span> ${team.name ?? d.id}`;

          const tdPoints = document.createElement('td');
          tdPoints.className = 'px-4 py-4 font-black text-neonCyan';
          tdPoints.textContent = String(team.points ?? 0);

          const tdPen = document.createElement('td');
          tdPen.className = 'px-4 py-4 rounded-r-2xl text-neonMagenta font-black';
          tdPen.textContent = String(team.penalties ?? 0);

          tr.appendChild(tdName);
          tr.appendChild(tdPoints);
          tr.appendChild(tdPen);
          teamsTable.appendChild(tr);
        });
      }, (err) => {
        console.error(err);
        teamsTable.innerHTML = '';
        setStatus('Sin permisos para leer equipos (Firestore).');
      });
    }

    async function triggerAutoAdvance() {
      if (autoAdvanceCooldown) return;
      autoAdvanceCooldown = true;
      setStatus('‚è±Ô∏è Avance autom√°tico en 3 segundos...');

      setTimeout(async () => {
        await avanzarPregunta();
        autoAdvanceCooldown = false;
      }, 3000);
    }

    async function avanzarPregunta() {
      setStatus('Avanzando pregunta...');
      try {
        const gameDoc = await getDoc(gameRef);
        let nextIndex = 0;
        if (gameDoc.exists() && typeof gameDoc.data().currentQuestionIndex !== 'undefined') {
          nextIndex = gameDoc.data().currentQuestionIndex + 1;
        }
        if (nextIndex >= preguntas.length) {
          await finishGame();
          return;
        }
        await setDoc(gameRef, { ended: false, endedAt: null, currentQuestionIndex: nextIndex, questionStartedAt: serverTimestamp() }, { merge: true });
        setStatus('Pregunta actualizada.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo avanzar (posible error de permisos en Firestore).');
      }
    }

    function limpiarReporte() {
      finalReport.classList.add('hidden');
      finalReportTable.innerHTML = '';
      setFinalReportStatus('');
    }

    btnClearReport.addEventListener('click', limpiarReporte);

    async function verDetalleEquipo(teamId) {
      const modal = document.getElementById('modal-detalle');
      const titulo = document.getElementById('modal-titulo');
      const contenido = document.getElementById('modal-contenido');

      titulo.innerText = `Respuestas del Equipo: ${teamId}`;
      contenido.innerHTML = '<p class="text-gray-400">Cargando detalles...</p>';
      modal.classList.remove('hidden');

      try {
        const answersRef = collection(db, `games/${GAME_ID}/teams/${teamId}/answers`);
        const answersSnap = await getDocs(answersRef);
        const answersMap = {};
        answersSnap.forEach(doc => {
          answersMap[doc.id] = doc.data();
        });

        contenido.innerHTML = '';
        preguntas.forEach((q, idx) => {
          const ans = answersMap[idx];
          const div = document.createElement('div');
          div.className = 'bg-white/5 border border-white/5 p-4 rounded-2xl text-sm transition-all hover:bg-white/10';

          let estadoHtml = '';
          if (!ans) {
            estadoHtml = '<span class="text-gray-500 font-black tracking-widest text-[9px] uppercase">[DESCONECTADO]</span>';
          } else if (ans.timeout) {
            estadoHtml = '<span class="text-neonMagenta font-black tracking-widest text-[9px] uppercase">[TIMEOUT]</span>';
          } else if (ans.isCorrect) {
            estadoHtml = '<span class="text-neonCyan font-black tracking-widest text-[9px] uppercase text-shadow-[0_0_10px_#00f2ff]">[CORRECTO]</span>';
          } else {
            estadoHtml = '<span class="text-rose-500 font-black tracking-widest text-[9px] uppercase">[ERROR]</span>';
          }

          const respuestaRecibida = ans ? (typeof ans.selectedIndex === 'number' ? q.opciones[ans.selectedIndex] : 'N/A') : 'N/A';
          const respuestaCorrecta = q.opciones[q.correcta];

          div.innerHTML = `
            <p class="font-bold text-gray-100 flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-neonPurple"></span> ${idx + 1}. ${q.pregunta}</p>
            <div class="mt-3 grid grid-cols-1 gap-2 text-xs">
              <p class="bg-black/40 p-2 rounded-xl border border-white/5"><span class="text-gray-500 font-bold uppercase text-[9px] tracking-widest block mb-1">Recibido</span> <span class="${ans?.isCorrect ? 'text-neonCyan font-black' : 'text-rose-400'}">${respuestaRecibida}</span></p>
              <p class="bg-black/40 p-2 rounded-xl border border-white/5"><span class="text-gray-500 font-bold uppercase text-[9px] tracking-widest block mb-1">Deseado</span> <span class="text-neonCyan font-black">${respuestaCorrecta}</span></p>
            </div>
            <div class="mt-2 flex justify-end">${estadoHtml}</div>
          `;
          contenido.appendChild(div);
        });

      } catch (err) {
        console.error(err);
        contenido.innerHTML = '<p class="text-red-400">Error cargando los detalles.</p>';
      }
    }
    window.verDetalleEquipo = verDetalleEquipo;

    window.cerrarModal = function () {
      document.getElementById('modal-detalle').classList.add('hidden');
    }

    btnNextQuestion.addEventListener('click', avanzarPregunta);

    btnEndGame.addEventListener('click', finishGame);

    btnWaitGroups.addEventListener('click', async () => {
      setStatus('Cambiando a modo espera...');
      try {
        await setDoc(gameRef, { ended: false, currentQuestionIndex: -1, questionStartedAt: null }, { merge: true });
        limpiarReporte();
        setStatus('Esperando grupos (Red Abierta).');
      } catch (err) {
        console.error(err);
        setStatus('Error al cambiar a modo espera.');
      }
    });

    btnResetGame.addEventListener('click', async () => {
      if (!confirm('¬øReiniciar el juego? Esto pone la pregunta en estado no iniciado.')) return;
      setStatus('Reiniciando juego...');
      try {
        await setDoc(gameRef, { ended: false, endedAt: null, currentQuestionIndex: -1, questionStartedAt: null }, { merge: true });
        setStatus('Juego reiniciado.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo reiniciar (posible error de permisos en Firestore).');
      }
    });

    btnResetPoints.addEventListener('click', async () => {
      if (!confirm('¬øRestablecer puntos y penalizaciones de TODOS los equipos a 0?')) return;
      setStatus('Restableciendo puntos...');
      try {
        const snap = await getDocs(teamsRef);
        const batch = writeBatch(db);
        snap.forEach((d) => {
          batch.update(d.ref, { points: 0, penalties: 0 });
        });
        await batch.commit();
        setStatus('Puntos restablecidos.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo restablecer puntos (posible error de permisos en Firestore).');
      }
    });

    btnDeleteTeams.addEventListener('click', async () => {
      if (!confirm('¬øBORRAR TODOS los equipos y su informaci√≥n?')) return;
      setStatus('Borrando equipos...');
      try {
        const snap = await getDocs(teamsRef);
        const batch = writeBatch(db);
        snap.forEach((d) => {
          batch.delete(d.ref);
        });
        await batch.commit();
        setStatus('Equipos borrados.');
        limpiarReporte();
      } catch (err) {
        console.error(err);
        setStatus('No se pudo borrar equipos (posible error de permisos en Firestore).');
      }
    });
  </script>
</body>

</html>