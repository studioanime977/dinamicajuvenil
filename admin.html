<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel del L√≠der</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100 font-sans">
  <div class="max-w-4xl mx-auto p-4 sm:p-8">
    <div class="bg-gray-800 rounded-2xl shadow-xl p-6">
      <h2 class="text-2xl sm:text-3xl font-extrabold">üëë Panel Admin</h2>
      <p class="text-gray-300 mt-2">Control del juego y equipos.</p>

      <div class="mt-6 flex flex-col sm:flex-row gap-3">
        <input id="clave" placeholder="Clave de admin" class="w-full sm:flex-1 px-4 py-3 rounded-lg bg-gray-900 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="btn-entrar" class="px-5 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 font-bold">Entrar</button>
      </div>

      <p id="admin-status" class="text-sm text-gray-300 mt-3"></p>
    </div>

    <div id="panel" class="hidden mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 bg-gray-800 rounded-2xl shadow-xl p-6">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <h3 class="text-xl font-bold">Equipos</h3>
          <div class="flex gap-2 flex-wrap">
            <button id="btn-next-question" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 font-bold">Siguiente Pregunta</button>
            <button id="btn-reset-points" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-bold">Restablecer puntos</button>
            <button id="btn-reset-game" class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 font-bold">Reiniciar juego</button>
            <button id="btn-delete-teams" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 font-bold">Borrar equipos</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="bg-gray-900 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-xs">Pregunta actual</p>
            <p id="current-question" class="text-lg font-extrabold">‚Äî</p>
          </div>
          <div class="bg-gray-900 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-xs">Equipos</p>
            <p id="team-count" class="text-lg font-extrabold">0</p>
          </div>
          <div class="bg-gray-900 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-xs">Estado</p>
            <p id="panel-status" class="text-sm text-gray-200">Listo</p>
          </div>
        </div>

        <div class="mt-5 overflow-x-auto">
          <table class="w-full text-left border-separate" style="border-spacing: 0 10px;">
            <thead>
              <tr class="text-gray-400 text-xs">
                <th class="px-4">Equipo</th>
                <th class="px-4">Puntos</th>
                <th class="px-4">Penalizaciones</th>
              </tr>
            </thead>
            <tbody id="teams-table"></tbody>
          </table>
        </div>

        <div class="mt-8">
          <h4 class="text-lg font-bold">Respuestas (pregunta actual)</h4>
          <p class="text-gray-300 text-sm mt-1">Se actualiza en vivo cuando los equipos contestan.</p>
          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-left border-separate" style="border-spacing: 0 10px;">
              <thead>
                <tr class="text-gray-400 text-xs">
                  <th class="px-4">Equipo</th>
                  <th class="px-4">Respuesta</th>
                  <th class="px-4">Correcta</th>
                  <th class="px-4">Puntos</th>
                </tr>
              </thead>
              <tbody id="answers-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="bg-gray-800 rounded-2xl shadow-xl p-6">
        <h3 class="text-xl font-bold">Preguntas (respuestas ocultas)</h3>
        <p class="text-gray-300 text-sm mt-2">Toca el üëÅÔ∏è para ver/ocultar la respuesta correcta.</p>
        <div id="questions" class="mt-4 space-y-3"></div>
      </div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      collectionGroup,
      query,
      orderBy,
      onSnapshot,
      where,
      getDocs,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC8xL6OM_ff7LqFJj_P87d9wVR-BT8OJsE",
      authDomain: "dinamica-en-tiempo-real.firebaseapp.com",
      projectId: "dinamica-en-tiempo-real",
      storageBucket: "dinamica-en-tiempo-real.firebasestorage.app",
      messagingSenderId: "1096669474654",
      appId: "1:1096669474654:web:0348238823f2a0cbdea9cf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const GAME_ID = "main-game";
    const gameRef = doc(db, `games/${GAME_ID}`);
    const teamsRef = collection(db, `games/${GAME_ID}/teams`);

    const adminRef = doc(db, "config", "admin");

    const panel = document.getElementById('panel');
    const adminStatus = document.getElementById('admin-status');
    const panelStatus = document.getElementById('panel-status');
    const btnEntrar = document.getElementById('btn-entrar');
    const btnNextQuestion = document.getElementById('btn-next-question');
    const btnResetPoints = document.getElementById('btn-reset-points');
    const btnDeleteTeams = document.getElementById('btn-delete-teams');
    const btnResetGame = document.getElementById('btn-reset-game');
    const teamsTable = document.getElementById('teams-table');
    const answersTable = document.getElementById('answers-table');
    const teamCount = document.getElementById('team-count');
    const currentQuestion = document.getElementById('current-question');
    const questionsEl = document.getElementById('questions');

    let currentQuestionIndex = -1;
    let unsubscribeAnswers = null;

    const preguntas = [
      {
        pregunta: "Seg√∫n 1 Samuel 2:30, Dios promete honrar a:",
        opciones: ["Los fuertes", "Los que lo honran", "Los que ayunan", "Los l√≠deres"],
        correcta: 1
      },
      {
        pregunta: "En la Biblia, honrar significa:",
        opciones: ["Exaltar el ego", "Obedecer y respetar", "Ser famoso", "Tener autoridad"],
        correcta: 1
      },
      {
        pregunta: "Honramos a Dios cuando:",
        opciones: ["Hablamos bonito", "Vivimos en obediencia", "Solo vamos a la iglesia", "Cantamos fuerte"],
        correcta: 1
      },
      {
        pregunta: "Romanos 12:1 ense√±a que la honra se demuestra con:",
        opciones: ["Sacrificios externos", "Nuestro cuerpo como sacrificio vivo", "Ofrendas econ√≥micas", "Ayunos largos"],
        correcta: 1
      },
      {
        pregunta: "Honrar a los padres trae como resultado:",
        opciones: ["Fama", "Larga vida", "Riqueza inmediata", "Poder"],
        correcta: 1
      },
      {
        pregunta: "Proverbios 3:9 ense√±a honrar a Dios con:",
        opciones: ["Palabras", "Tiempo", "Bienes", "Ayuno"],
        correcta: 2
      },
      {
        pregunta: "Honrar a Dios incluye obedecer cuando:",
        opciones: ["Es c√≥modo", "Es p√∫blico", "Nadie ve", "Hay recompensa"],
        correcta: 2
      },
      {
        pregunta: "Honra verdadera se demuestra con:",
        opciones: ["Intenciones", "Emociones", "Acciones", "Apariencia"],
        correcta: 2
      },
      {
        pregunta: "Juan 5:23 ense√±a que honrar al Hijo es:",
        opciones: ["Opcional", "Igual a honrar al Padre", "Solo para l√≠deres", "Algo simb√≥lico"],
        correcta: 1
      },
      {
        pregunta: "Honrar a la familia implica:",
        opciones: ["Palabras bonitas", "Responsabilidad y cuidado", "Control", "Autoridad"],
        correcta: 1
      },
      {
        pregunta: "La honra produce:",
        opciones: ["Orgullo", "Bendici√≥n", "Confusi√≥n", "Temor"],
        correcta: 1
      },
      {
        pregunta: "La honra comienza primero en:",
        opciones: ["La iglesia", "La sociedad", "El coraz√≥n", "El dinero"],
        correcta: 2
      },

      {
        pregunta: "La deshonra es:",
        opciones: ["Falta de conocimiento", "Desobediencia y desprecio", "Ignorancia", "Debilidad"],
        correcta: 1
      },
      {
        pregunta: "Seg√∫n Proverbios 11:2, la deshonra trae:",
        opciones: ["Paz", "Prosperidad", "Humillaci√≥n", "Autoridad"],
        correcta: 2
      },
      {
        pregunta: "Deshonrar a los padres provoca:",
        opciones: ["Bendici√≥n", "Consecuencias negativas", "Fama", "Sabidur√≠a"],
        correcta: 1
      },
      {
        pregunta: "Malaqu√≠as 1:6 muestra deshonra cuando:",
        opciones: ["Dios no responde", "Se da lo peor a Dios", "Se ora poco", "No se canta"],
        correcta: 1
      },
      {
        pregunta: "La deshonra se manifiesta cuando:",
        opciones: ["Hay silencio", "Hay rebeld√≠a", "Hay humildad", "Hay servicio"],
        correcta: 1
      },
      {
        pregunta: "Seg√∫n la Biblia, hablar mal de autoridades es:",
        opciones: ["Libertad", "Opini√≥n", "Deshonra", "Correcci√≥n"],
        correcta: 2
      },
      {
        pregunta: "La deshonra bloquea:",
        opciones: ["El perd√≥n", "La bendici√≥n", "El tiempo", "El conocimiento"],
        correcta: 1
      },
      {
        pregunta: "Deshonrar a Dios ocurre cuando:",
        opciones: ["No entendemos", "Vivimos en pecado consciente", "Oramos poco", "No ayunamos"],
        correcta: 1
      },
      {
        pregunta: "La deshonra produce:",
        opciones: ["Orden", "Confianza", "Conflictos", "Gozo"],
        correcta: 2
      },
      {
        pregunta: "Ejemplo claro de deshonra es:",
        opciones: ["Obedecer con gozo", "Servir con amor", "Menospreciar la autoridad", "Respetar normas"],
        correcta: 2
      },
      {
        pregunta: "La deshonra comienza cuando:",
        opciones: ["Se habla", "Se piensa mal", "Se act√∫a", "Se decide obedecer"],
        correcta: 1
      },
      {
        pregunta: "El ant√≠doto b√≠blico contra la deshonra es:",
        opciones: ["El silencio", "El castigo", "El arrepentimiento y la obediencia", "El temor humano"],
        correcta: 2
      }
    ];

    function setStatus(text) {
      panelStatus.textContent = text;
    }

    function renderAnswersEmpty(message) {
      answersTable.innerHTML = '';
      const tr = document.createElement('tr');
      tr.className = 'bg-gray-900 border border-gray-700';
      const td = document.createElement('td');
      td.colSpan = 4;
      td.className = 'px-4 py-3 rounded-xl text-gray-300';
      td.textContent = message;
      tr.appendChild(td);
      answersTable.appendChild(tr);
    }

    function listenAnswersForQuestion(index) {
      if (unsubscribeAnswers) {
        unsubscribeAnswers();
        unsubscribeAnswers = null;
      }

      if (typeof index !== 'number' || index < 0) {
        renderAnswersEmpty('Sin pregunta activa.');
        return;
      }

      renderAnswersEmpty('Esperando respuestas...');

      const answersQuery = query(
        collectionGroup(db, 'answers'),
        where('questionIndex', '==', index)
      );

      unsubscribeAnswers = onSnapshot(answersQuery, (snap) => {
        answersTable.innerHTML = '';
        if (snap.empty) {
          renderAnswersEmpty('Esperando respuestas...');
          return;
        }

        snap.forEach((d) => {
          const data = d.data();
          const teamId = d.ref.parent?.parent?.id ?? '‚Äî';
          const selectedLetter = typeof data.selectedIndex === 'number' ? String.fromCharCode(65 + data.selectedIndex) : '‚Äî';
          const correctLetter = typeof data.correctIndex === 'number' ? String.fromCharCode(65 + data.correctIndex) : '‚Äî';
          const isCorrect = !!data.isCorrect;

          const tr = document.createElement('tr');
          tr.className = 'bg-gray-900 border border-gray-700';

          const tdTeam = document.createElement('td');
          tdTeam.className = 'px-4 py-3 rounded-l-xl font-bold';
          tdTeam.textContent = teamId;

          const tdSel = document.createElement('td');
          tdSel.className = 'px-4 py-3';
          tdSel.textContent = selectedLetter;

          const tdCorrect = document.createElement('td');
          tdCorrect.className = `px-4 py-3 font-bold ${isCorrect ? 'text-green-300' : 'text-red-300'}`;
          tdCorrect.textContent = correctLetter;

          const tdPoints = document.createElement('td');
          tdPoints.className = 'px-4 py-3 rounded-r-xl';
          tdPoints.textContent = String(data.pointsChange ?? '‚Äî');

          tr.appendChild(tdTeam);
          tr.appendChild(tdSel);
          tr.appendChild(tdCorrect);
          tr.appendChild(tdPoints);
          answersTable.appendChild(tr);
        });
      }, (err) => {
        console.error(err);
        if (err?.code === 'permission-denied') {
          renderAnswersEmpty('Sin permisos para leer respuestas (Firestore).');
        } else {
          renderAnswersEmpty('Error leyendo respuestas.');
        }
      });
    }

    function renderQuestions() {
      questionsEl.innerHTML = '';
      preguntas.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-gray-900 border border-gray-700 rounded-xl p-4';

        const header = document.createElement('div');
        header.className = 'flex items-start justify-between gap-3';

        const title = document.createElement('div');
        title.className = 'font-bold';
        title.textContent = `${idx + 1}. ${q.pregunta}`;

        const toggleQuestion = document.createElement('button');
        toggleQuestion.className = 'shrink-0 px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 border border-gray-700 font-bold text-sm';
        toggleQuestion.textContent = 'Mostrar';

        header.appendChild(title);
        header.appendChild(toggleQuestion);

        const options = document.createElement('div');
        options.className = 'mt-3 space-y-1 text-sm text-gray-200';
        q.opciones.forEach((opt, i) => {
          const line = document.createElement('div');
          line.textContent = `${String.fromCharCode(65 + i)}) ${opt}`;
          options.appendChild(line);
        });

        const footer = document.createElement('div');
        footer.className = 'mt-4 flex items-center justify-between gap-3';

        const answer = document.createElement('div');
        answer.className = 'text-sm text-green-300 hidden';
        answer.textContent = `Correcta: ${String.fromCharCode(65 + q.correcta)} ) ${q.opciones[q.correcta]}`;

        const toggle = document.createElement('button');
        toggle.className = 'px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 border border-gray-700 font-bold';
        toggle.textContent = 'üëÅÔ∏è';
        toggle.addEventListener('click', () => {
          answer.classList.toggle('hidden');
        });

        footer.appendChild(answer);
        footer.appendChild(toggle);

        const content = document.createElement('div');
        content.className = 'hidden';
        content.appendChild(options);
        content.appendChild(footer);

        toggleQuestion.addEventListener('click', () => {
          const willShow = content.classList.contains('hidden');
          content.classList.toggle('hidden');
          toggleQuestion.textContent = willShow ? 'Ocultar' : 'Mostrar';
          if (!willShow) {
            answer.classList.add('hidden');
          }
        });

        card.appendChild(header);
        card.appendChild(content);
        questionsEl.appendChild(card);
      });
    }

    async function entrar() {
      adminStatus.textContent = '';
      const claveIngresada = document.getElementById('clave').value;
      let snap;
      try {
        snap = await getDoc(adminRef);
      } catch (err) {
        console.error(err);
        adminStatus.textContent = 'Error leyendo la clave (posible error de permisos en Firestore).';
        return;
      }

      if (snap.exists() && snap.data().clave === claveIngresada) {
        panel.classList.remove('hidden');
        adminStatus.textContent = 'Acceso concedido.';
        escuchar();
        renderQuestions();
      } else {
        adminStatus.textContent = 'Clave incorrecta.';
      }
    }

    btnEntrar.addEventListener('click', entrar);

    function escuchar() {
      const teamsQuery = query(teamsRef, orderBy('points', 'desc'));

      onSnapshot(gameRef, (snap) => {
        if (!snap.exists()) {
          currentQuestion.textContent = '‚Äî';
          return;
        }
        const idx = snap.data().currentQuestionIndex;
        currentQuestionIndex = typeof idx === 'number' ? idx : -1;
        if (typeof idx === 'number' && idx >= 0) {
          currentQuestion.textContent = `#${idx + 1}`;
        } else {
          currentQuestion.textContent = 'No iniciada';
        }

        listenAnswersForQuestion(currentQuestionIndex);
      }, (err) => {
        console.error(err);
        currentQuestion.textContent = '‚Äî';
      });

      onSnapshot(teamsQuery, (snap) => {
        teamCount.textContent = snap.size;
        teamsTable.innerHTML = '';
        snap.forEach((d) => {
          const team = d.data();
          const tr = document.createElement('tr');
          tr.className = 'bg-gray-900 border border-gray-700';

          const tdName = document.createElement('td');
          tdName.className = 'px-4 py-3 rounded-l-xl font-bold';
          tdName.textContent = team.name ?? d.id;

          const tdPoints = document.createElement('td');
          tdPoints.className = 'px-4 py-3 font-extrabold text-indigo-300';
          tdPoints.textContent = String(team.points ?? 0);

          const tdPen = document.createElement('td');
          tdPen.className = 'px-4 py-3 rounded-r-xl text-gray-200';
          tdPen.textContent = String(team.penalties ?? 0);

          tr.appendChild(tdName);
          tr.appendChild(tdPoints);
          tr.appendChild(tdPen);
          teamsTable.appendChild(tr);
        });
      }, (err) => {
        console.error(err);
        teamsTable.innerHTML = '';
        setStatus('Sin permisos para leer equipos (Firestore).');
      });
    }

    btnNextQuestion.addEventListener('click', async () => {
      setStatus('Avanzando pregunta...');
      try {
        const gameDoc = await getDoc(gameRef);
        let nextIndex = 0;
        if (gameDoc.exists() && typeof gameDoc.data().currentQuestionIndex !== 'undefined') {
          nextIndex = gameDoc.data().currentQuestionIndex + 1;
        }
        if (nextIndex >= preguntas.length) nextIndex = 0;
        await setDoc(gameRef, { currentQuestionIndex: nextIndex }, { merge: true });
        setStatus('Pregunta actualizada.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo avanzar (posible error de permisos en Firestore).');
      }
    });

    btnResetGame.addEventListener('click', async () => {
      if (!confirm('¬øReiniciar el juego? Esto pone la pregunta en estado no iniciado.')) return;
      setStatus('Reiniciando juego...');
      try {
        await setDoc(gameRef, { currentQuestionIndex: -1 }, { merge: true });
        setStatus('Juego reiniciado.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo reiniciar (posible error de permisos en Firestore).');
      }
    });

    btnResetPoints.addEventListener('click', async () => {
      if (!confirm('¬øRestablecer puntos y penalizaciones de TODOS los equipos a 0?')) return;
      setStatus('Restableciendo puntos...');
      try {
        const snap = await getDocs(teamsRef);
        const batch = writeBatch(db);
        snap.forEach((d) => {
          batch.update(d.ref, { points: 0, penalties: 0 });
        });
        await batch.commit();
        setStatus('Puntos restablecidos.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo restablecer puntos (posible error de permisos en Firestore).');
      }
    });

    btnDeleteTeams.addEventListener('click', async () => {
      if (!confirm('¬øBORRAR TODOS los equipos y su informaci√≥n?')) return;
      setStatus('Borrando equipos...');
      try {
        const snap = await getDocs(teamsRef);
        const batch = writeBatch(db);
        snap.forEach((d) => {
          batch.delete(d.ref);
        });
        await batch.commit();
        setStatus('Equipos borrados.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo borrar equipos (posible error de permisos en Firestore).');
      }
    });
  </script>
</body>
</html>
