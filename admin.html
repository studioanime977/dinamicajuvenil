<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Panel del L√≠der</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-[#0f0f0f] via-[#241a06] to-[#0a0a0a] min-h-screen text-gray-100 font-sans">
  <div class="max-w-4xl mx-auto p-4 sm:p-8">
    <div
      class="bg-[#1a1409]/80 backdrop-blur-xl border border-amber-500/20 shadow-[0_0_50px_rgba(212,175,55,0.12)] rounded-2xl p-6">
      <h2
        class="text-2xl sm:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-amber-200 via-yellow-500 to-orange-400">
        üëë Panel Admin</h2>
      <p class="text-gray-200/80 mt-2">Control autom√°tico y gesti√≥n del juego.</p>

      <div class="mt-4 flex items-center gap-2">
        <input type="checkbox" id="auto-advance" class="w-5 h-5 accent-amber-500">
        <label for="auto-advance" class="text-amber-200 font-bold">Modo Avance Autom√°tico (Pasar pregunta al completar
          respuestas)</label>
      </div>

      <div class="mt-6 flex flex-col sm:flex-row gap-3">
        <input type="password" id="clave" placeholder="Clave de admin"
          class="w-full sm:flex-1 px-4 py-3 rounded-lg bg-[#0f0c05] border border-amber-500/30 focus:outline-none focus:ring-2 focus:ring-amber-400/70 text-gray-100 placeholder:text-gray-400">
        <button id="btn-entrar"
          class="px-5 py-3 rounded-lg bg-gradient-to-r from-amber-600 to-yellow-500 text-gray-900 font-extrabold">Entrar</button>
      </div>

      <p id="admin-status" class="text-sm text-gray-200/80 mt-3"></p>
    </div>

    <div id="panel" class="hidden mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div
        class="lg:col-span-2 bg-[#0b1020]/80 backdrop-blur-xl border border-cyan-500/20 shadow-[0_0_50px_rgba(34,211,238,0.10)] rounded-2xl p-6">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <h3 class="text-xl font-bold">Equipos</h3>
          <div class="flex gap-2 flex-wrap">
            <button id="btn-next-question"
              class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-gray-900 font-extrabold ring-2 ring-emerald-300/30">Siguiente
              Pregunta</button>
            <button id="btn-end-game"
              class="px-4 py-2 rounded-lg bg-yellow-400 hover:bg-yellow-300 text-gray-900 font-extrabold ring-2 ring-yellow-200/30">Terminar
              juego</button>
            <button id="btn-reset-points"
              class="px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-extrabold ring-2 ring-cyan-300/30">Restablecer
              puntos</button>
            <button id="btn-reset-game"
              class="px-4 py-2 rounded-lg bg-violet-500 hover:bg-violet-400 text-gray-900 font-extrabold ring-2 ring-violet-300/30">Reiniciar
              juego</button>
            <button id="btn-delete-teams"
              class="px-4 py-2 rounded-lg bg-rose-500 hover:bg-rose-400 text-gray-900 font-extrabold ring-2 ring-rose-300/30">Borrar
              equipos</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="bg-[#0f0c05] rounded-xl p-4 border border-amber-500/20">
            <p class="text-gray-400 text-xs">Pregunta actual</p>
            <p id="current-question" class="text-lg font-extrabold text-amber-300">‚Äî</p>
          </div>
          <div class="bg-[#0f0c05] rounded-xl p-4 border border-amber-500/20">
            <p class="text-gray-400 text-xs">Equipos</p>
            <p id="team-count" class="text-lg font-extrabold text-amber-300">0</p>
          </div>
          <div class="bg-[#0f0c05] rounded-xl p-4 border border-amber-500/20">
            <p class="text-gray-400 text-xs">Estado</p>
            <p id="panel-status" class="text-sm text-gray-200">Listo</p>
          </div>
        </div>

        <div class="mt-5 overflow-x-auto">
          <table class="w-full text-left border-separate" style="border-spacing: 0 10px;">
            <thead>
              <tr class="text-gray-400 text-xs">
                <th class="px-4">Equipo</th>
                <th class="px-4">Puntos</th>
                <th class="px-4">Penalizaciones</th>
              </tr>
            </thead>
            <tbody id="teams-table"></tbody>
          </table>
        </div>

        <div class="mt-8">
          <h4 class="text-lg font-bold">Respuestas (pregunta actual)</h4>
          <p class="text-gray-300 text-sm mt-1">Se actualiza en vivo cuando los equipos contestan.</p>
          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-left border-separate" style="border-spacing: 0 10px;">
              <thead>
                <tr class="text-gray-400 text-xs">
                  <th class="px-4">Equipo</th>
                  <th class="px-4">Respuesta</th>
                  <th class="px-4">Correcta</th>
                  <th class="px-4">Puntos</th>
                </tr>
              </thead>
              <tbody id="answers-table"></tbody>
            </table>
          </div>
        </div>

        <div id="final-report" class="hidden mt-10">
          <div class="flex items-center justify-between gap-4 flex-wrap">
            <h4 class="text-lg font-bold">Reporte final</h4>
            <span id="final-report-status" class="text-sm text-gray-300"></span>
          </div>
          <p class="text-gray-300 text-sm mt-1">Puntos + correctas/incorrectas/timeout y % de conocimiento.</p>
          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-left border-separate" style="border-spacing: 0 10px;">
              <thead>
                <tr class="text-gray-400 text-xs">
                  <th class="px-4">Equipo</th>
                  <th class="px-4">Puntos</th>
                  <th class="px-4">Buenas</th>
                  <th class="px-4">Malas</th>
                  <th class="px-4">Sin responder</th>
                  <th class="px-4">% Conocimiento</th>
                  <th class="px-4">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="final-report-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div
        class="bg-[#0b1020]/80 backdrop-blur-xl border border-cyan-500/20 shadow-[0_0_50px_rgba(34,211,238,0.10)] rounded-2xl p-6">
        <h3 class="text-xl font-bold">Preguntas (respuestas ocultas)</h3>
        <p class="text-gray-300 text-sm mt-2">Toca el üëÅÔ∏è para ver/ocultar la respuesta correcta.</p>
        <div id="questions" class="mt-4 space-y-3"></div>
      </div>
    </div>
  </div>

  <!-- Modal de Detalle de Respuestas -->
  <div id="modal-detalle"
    class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div
      class="bg-[#1a1409] border border-amber-500/30 w-full max-w-2xl max-h-[80vh] overflow-y-auto rounded-2xl p-6 shadow-2xl">
      <div class="flex justify-between items-center mb-4 border-b border-amber-500/20 pb-2">
        <h3 id="modal-titulo" class="text-xl font-bold text-amber-200">Detalle de Equipo</h3>
        <button onclick="cerrarModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="modal-contenido" class="space-y-4">
        <!-- Detalles de respuestas aqu√≠ -->
      </div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      collectionGroup,
      query,
      orderBy,
      onSnapshot,
      where,
      getDocs,
      writeBatch,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC8xL6OM_ff7LqFJj_P87d9wVR-BT8OJsE",
      authDomain: "dinamica-en-tiempo-real.firebaseapp.com",
      projectId: "dinamica-en-tiempo-real",
      storageBucket: "dinamica-en-tiempo-real.firebasestorage.app",
      messagingSenderId: "1096669474654",
      appId: "1:1096669474654:web:0348238823f2a0cbdea9cf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const GAME_ID = "main-game";
    const gameRef = doc(db, `games/${GAME_ID}`);
    const teamsRef = collection(db, `games/${GAME_ID}/teams`);

    const adminRef = doc(db, "config", "admin");

    const panel = document.getElementById('panel');
    const adminStatus = document.getElementById('admin-status');
    const panelStatus = document.getElementById('panel-status');
    const btnEntrar = document.getElementById('btn-entrar');
    const btnNextQuestion = document.getElementById('btn-next-question');
    const btnEndGame = document.getElementById('btn-end-game');
    const btnResetPoints = document.getElementById('btn-reset-points');
    const btnDeleteTeams = document.getElementById('btn-delete-teams');
    const btnResetGame = document.getElementById('btn-reset-game');
    const teamsTable = document.getElementById('teams-table');
    const answersTable = document.getElementById('answers-table');
    const teamCount = document.getElementById('team-count');
    const currentQuestion = document.getElementById('current-question');
    const questionsEl = document.getElementById('questions');
    const finalReport = document.getElementById('final-report');
    const finalReportStatus = document.getElementById('final-report-status');
    const finalReportTable = document.getElementById('final-report-table');
    const autoAdvanceCheck = document.getElementById('auto-advance');

    let currentQuestionIndex = -1;
    let registeredTeamsCount = 0;
    let unsubscribeAnswers = null;
    let autoAdvanceCooldown = false;

    const preguntas = [
      {
        pregunta: "Seg√∫n Lucas 3:8, ¬øqu√© prueba que una persona se ha arrepentido de verdad y ha vuelto a Dios?",
        opciones: ["Decir 'estamos a salvo por Abraham'", "Demostrarlo con su forma de vivir", "Pertenecer a una familia con linaje espiritual", "Realizar sacrificios y ofrendas"],
        correcta: 1
      },
      {
        pregunta: "¬øA qu√© se refiere el concepto de que 'Dios no tiene nietos'?",
        opciones: ["A que Dios solo ama a sus hijos biol√≥gicos", "A que la fe no se hereda; cada uno necesita un encuentro personal", "A que los ancianos no pueden conocer a Dios de verdad", "A que la descendencia de Abraham fue un error"],
        correcta: 1
      },
      {
        pregunta: "En Lucas 10:41-42, ¬øcu√°l fue la '√∫nica cosa' necesaria que Mar√≠a descubri√≥ y Marta ignor√≥?",
        opciones: ["Servir con excelencia a los invitados", "La preocupaci√≥n por los detalles del altar", "Estar en Su presencia y escuchar Su palabra", "Ayudar a los pobres de la aldea"],
        correcta: 2
      },
      {
        pregunta: "¬øQu√© sucede cuando el servicio a Dios carece de una relaci√≥n personal?",
        opciones: ["Se vuelve m√°s eficiente por la disciplina", "Se convierte en rutina y la rutina en vac√≠o", "Se santifica por el esfuerzo realizado", "Te garantiza un lugar en el cielo"],
        correcta: 1
      },
      {
        pregunta: "Seg√∫n Efesios 2:8-9, ¬øpor qu√© raz√≥n ninguno de nosotros puede jactarse de ser salvo?",
        opciones: ["Porque la salvaci√≥n es un premio individual", "Porque la salvaci√≥n es un regalo de Dios, no por m√©ritos", "Porque el orgullo es un pecado menor", "Porque las obras buenas son opcionales"],
        correcta: 1
      },
      {
        pregunta: "En G√©nesis 32, ¬øcu√°l fue el prop√≥sito real del quebrantamiento de Jacob al luchar con el √°ngel?",
        opciones: ["Castigarlo por enga√±ar a su hermano Esa√∫", "Transformar su identidad de 'suplantador' a Israel", "Demostrar que el √°ngel era m√°s fuerte que √©l", "Quitarle sus riquezas acumuladas"],
        correcta: 1
      },
      {
        pregunta: "El 'Heme aqu√≠' de Samuel, a diferencia de los hijos de El√≠, representaba:",
        opciones: ["Que √©l era el m√°s preparado teol√≥gicamente", "Una actitud de obediencia radical y honra desde el coraz√≥n", "Que no ten√≠a otros compromisos en el templo", "Una respuesta autom√°tica por miedo al castigo"],
        correcta: 1
      },
      {
        pregunta: "Seg√∫n las notas, ¬øcu√°l es la ra√≠z com√∫n de todas las cosas 'disfrazadas de honra'?",
        opciones: ["La falta de recursos econ√≥micos", "El orgullo disfrazado que se resiste a renunciar al 'yo'", "La falta de tiempo para orar", "La timidez de los creyentes"],
        correcta: 1
      },
      {
        pregunta: "Seg√∫n Mateo 16:24, ¬øcu√°l es el requisito indispensable para ser un seguidor de Jes√∫s?",
        opciones: ["Ganar el mundo entero primero", "Negarse a s√≠ mismo, tomar su cruz y seguirlo", "Tener una reputaci√≥n intachable en la sociedad", "Cumplir con todas las tradiciones heredadas"],
        correcta: 1
      },
      {
        pregunta: "Basado en 1 Juan 4:18, quien a√∫n tiene miedo al castigo demuestra que:",
        opciones: ["Es una persona muy prudente", "No ha experimentado plenamente el perfecto amor de Dios", "Tiene un temor santo y necesario", "Est√° a un paso de la perfecci√≥n"],
        correcta: 1
      },
      {
        pregunta: "¬øCu√°l es la diferencia fundamental entre los actos fingidos y los frutos del coraz√≥n?",
        opciones: ["Los actos son siempre m√°s visibles", "Los actos pueden fingirse, pero los frutos revelan el coraz√≥n real", "Los frutos solo aparecen en personas perfectas", "No hay diferencia si la intenci√≥n es buena"],
        correcta: 1
      },
      {
        pregunta: "¬øPor qu√© el amor es descrito como el elemento que 'mata el orgullo'?",
        opciones: ["Porque te hace sentir superior a los que no aman", "Porque te lleva a desear tanto a Dios que ya no quieres pecar", "Porque el amor es una emoci√≥n pasajera", "Porque elimina la necesidad de tener una relaci√≥n"],
        correcta: 1
      }
    ];

    function setStatus(text) {
      panelStatus.textContent = text;
    }

    function setFinalReportStatus(text) {
      finalReportStatus.textContent = text;
    }

    function renderFinalRow({ teamId, points, correct, wrong, timeout, knowledgePercent }) {
      const tr = document.createElement('tr');
      tr.className = 'bg-gray-900 border border-gray-700';

      const tdTeam = document.createElement('td');
      tdTeam.className = 'px-4 py-3 rounded-l-xl font-bold';
      tdTeam.textContent = teamId;

      const tdPoints = document.createElement('td');
      tdPoints.className = 'px-4 py-3 font-extrabold text-indigo-300';
      tdPoints.textContent = String(points ?? 0);

      const tdC = document.createElement('td');
      tdC.className = 'px-4 py-3 text-green-300 font-bold';
      tdC.textContent = String(correct);

      const tdW = document.createElement('td');
      tdW.className = 'px-4 py-3 text-red-300 font-bold';
      tdW.textContent = String(wrong);

      const tdT = document.createElement('td');
      tdT.className = 'px-4 py-3 text-yellow-300 font-bold';
      tdT.textContent = String(timeout);

      const tdP = document.createElement('td');
      tdP.className = 'px-4 py-3 font-extrabold';
      tdP.textContent = `${knowledgePercent}%`;

      const tdAction = document.createElement('td');
      tdAction.className = 'px-4 py-3 rounded-r-xl';
      const btn = document.createElement('button');
      btn.innerText = 'Ver Detalles';
      btn.className = 'text-xs bg-amber-600 hover:bg-amber-500 text-gray-900 font-bold py-1 px-3 rounded-lg transition';
      btn.onclick = () => verDetalleEquipo(teamId);
      tdAction.appendChild(btn);

      tr.appendChild(tdTeam);
      tr.appendChild(tdPoints);
      tr.appendChild(tdC);
      tr.appendChild(tdW);
      tr.appendChild(tdT);
      tr.appendChild(tdP);
      tr.appendChild(tdAction);
      finalReportTable.appendChild(tr);
    }

    async function finishGame() {
      if (!confirm('¬øTerminar el juego? Esto mostrar√° el reporte final.')) return;

      setStatus('Terminando juego...');
      finalReport.classList.remove('hidden');
      finalReportTable.innerHTML = '';
      setFinalReportStatus('Calculando...');

      try {
        await setDoc(gameRef, { ended: true, endedAt: serverTimestamp(), currentQuestionIndex: -1, questionStartedAt: null }, { merge: true });
      } catch (err) {
        console.error(err);
        setStatus('No se pudo marcar terminado (posible error de permisos en Firestore).');
        setFinalReportStatus('Error marcando terminado.');
        return;
      }

      try {
        const teamsSnap = await getDocs(teamsRef);
        const totalQuestions = preguntas.length;

        for (const teamDoc of teamsSnap.docs) {
          const teamId = teamDoc.id;
          const teamData = teamDoc.data();

          let correct = 0;
          let wrong = 0;
          let timeout = 0;

          const answersRef = collection(db, `games/${GAME_ID}/teams/${teamId}/answers`);
          const answersSnap = await getDocs(answersRef);
          answersSnap.forEach((a) => {
            const ad = a.data();
            if (ad?.timeout) {
              timeout += 1;
              return;
            }
            if (ad?.isCorrect) correct += 1;
            else wrong += 1;
          });

          const knowledgePercent = totalQuestions > 0 ? Math.round((correct / totalQuestions) * 100) : 0;

          renderFinalRow({
            teamId,
            points: teamData?.points ?? 0,
            correct,
            wrong,
            timeout,
            knowledgePercent
          });

          // Guardar resumen en el doc del equipo para que quede persistente
          try {
            await setDoc(teamDoc.ref, {
              stats: {
                totalQuestions,
                correct,
                wrong,
                timeout,
                knowledgePercent,
                updatedAt: serverTimestamp()
              }
            }, { merge: true });
          } catch (err) {
            console.error(err);
          }
        }

        setStatus('Juego terminado.');
        setFinalReportStatus('Listo.');
      } catch (err) {
        console.error(err);
        setStatus('Juego terminado, pero fall√≥ el c√°lculo del reporte.');
        setFinalReportStatus('Error calculando reporte.');
      }
    }

    function renderAnswersEmpty(message) {
      answersTable.innerHTML = '';
      const tr = document.createElement('tr');
      tr.className = 'bg-gray-900 border border-gray-700';
      const td = document.createElement('td');
      td.colSpan = 4;
      td.className = 'px-4 py-3 rounded-xl text-gray-300';
      td.textContent = message;
      tr.appendChild(td);
      answersTable.appendChild(tr);
    }

    function listenAnswersForQuestion(index) {
      if (unsubscribeAnswers) {
        unsubscribeAnswers();
        unsubscribeAnswers = null;
      }

      if (typeof index !== 'number' || index < 0) {
        renderAnswersEmpty('Sin pregunta activa.');
        return;
      }

      renderAnswersEmpty('Esperando respuestas...');

      const answersQuery = query(
        collectionGroup(db, 'answers'),
        where('questionIndex', '==', index)
      );

      unsubscribeAnswers = onSnapshot(answersQuery, (snap) => {
        answersTable.innerHTML = '';
        if (snap.empty) {
          renderAnswersEmpty('Esperando respuestas...');
          return;
        }

        let answersCount = 0;
        snap.forEach((d) => {
          answersCount++;
          const data = d.data();
          const teamId = d.ref.parent?.parent?.id ?? '‚Äî';
          const selectedLetter = typeof data.selectedIndex === 'number' ? String.fromCharCode(65 + data.selectedIndex) : '‚Äî';
          const correctLetter = typeof data.correctIndex === 'number' ? String.fromCharCode(65 + data.correctIndex) : '‚Äî';
          const isCorrect = !!data.isCorrect;

          const tr = document.createElement('tr');
          tr.className = 'bg-gray-900 border border-gray-700';

          const tdTeam = document.createElement('td');
          tdTeam.className = 'px-4 py-3 rounded-l-xl font-bold';
          tdTeam.textContent = teamId;

          const tdSel = document.createElement('td');
          tdSel.className = 'px-4 py-3';
          tdSel.textContent = selectedLetter;

          const tdCorrect = document.createElement('td');
          tdCorrect.className = `px-4 py-3 font-bold ${isCorrect ? 'text-green-300' : 'text-red-300'}`;
          tdCorrect.textContent = correctLetter;

          const tdPoints = document.createElement('td');
          tdPoints.className = 'px-4 py-3 rounded-r-xl';
          tdPoints.textContent = String(data.pointsChange ?? '‚Äî');

          tr.appendChild(tdTeam);
          tr.appendChild(tdSel);
          tr.appendChild(tdCorrect);
          tr.appendChild(tdPoints);
          answersTable.appendChild(tr);
        });

        // L√≥gica de avance autom√°tico
        if (autoAdvanceCheck.checked && !autoAdvanceCooldown && registeredTeamsCount > 0 && answersCount >= registeredTeamsCount) {
          triggerAutoAdvance();
        }
      }, (err) => {
        console.error(err);
        if (err?.code === 'permission-denied') {
          renderAnswersEmpty('Sin permisos para leer respuestas (Firestore).');
        } else {
          renderAnswersEmpty('Error leyendo respuestas.');
        }
      });
    }

    function renderQuestions() {
      questionsEl.innerHTML = '';
      preguntas.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-gray-900 border border-gray-700 rounded-xl p-4';

        const header = document.createElement('div');
        header.className = 'flex items-start justify-between gap-3';

        const title = document.createElement('div');
        title.className = 'font-bold';
        title.textContent = `${idx + 1}. ${q.pregunta}`;

        const toggleQuestion = document.createElement('button');
        toggleQuestion.className = 'shrink-0 px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 border border-gray-700 font-bold text-sm';
        toggleQuestion.textContent = 'Mostrar';

        header.appendChild(title);
        header.appendChild(toggleQuestion);

        const options = document.createElement('div');
        options.className = 'mt-3 space-y-1 text-sm text-gray-200';
        q.opciones.forEach((opt, i) => {
          const line = document.createElement('div');
          line.textContent = `${String.fromCharCode(65 + i)}) ${opt}`;
          options.appendChild(line);
        });

        const footer = document.createElement('div');
        footer.className = 'mt-4 flex items-center justify-between gap-3';

        const answer = document.createElement('div');
        answer.className = 'text-sm text-green-300 hidden';
        answer.textContent = `Correcta: ${String.fromCharCode(65 + q.correcta)} ) ${q.opciones[q.correcta]}`;

        const toggle = document.createElement('button');
        toggle.className = 'px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 border border-gray-700 font-bold';
        toggle.textContent = 'üëÅÔ∏è';
        toggle.addEventListener('click', () => {
          answer.classList.toggle('hidden');
        });

        footer.appendChild(answer);
        footer.appendChild(toggle);

        const content = document.createElement('div');
        content.className = 'hidden';
        content.appendChild(options);
        content.appendChild(footer);

        toggleQuestion.addEventListener('click', () => {
          const willShow = content.classList.contains('hidden');
          content.classList.toggle('hidden');
          toggleQuestion.textContent = willShow ? 'Ocultar' : 'Mostrar';
          if (!willShow) {
            answer.classList.add('hidden');
          }
        });

        card.appendChild(header);
        card.appendChild(content);
        questionsEl.appendChild(card);
      });
    }

    async function entrar() {
      adminStatus.textContent = '';
      const claveIngresada = document.getElementById('clave').value;
      let snap;
      try {
        snap = await getDoc(adminRef);
      } catch (err) {
        console.error(err);
        adminStatus.textContent = 'Error leyendo la clave (posible error de permisos en Firestore).';
        return;
      }

      if (snap.exists() && snap.data().clave === claveIngresada) {
        panel.classList.remove('hidden');
        adminStatus.textContent = 'Acceso concedido.';
        try {
          await setDoc(gameRef, { currentQuestionIndex: -1, questionStartedAt: null, ended: false, endedAt: null }, { merge: true });
        } catch (err) {
          console.error(err);
        }
        escuchar();
        renderQuestions();
      } else {
        adminStatus.textContent = 'Clave incorrecta.';
      }
    }

    btnEntrar.addEventListener('click', entrar);

    function escuchar() {
      const teamsQuery = query(teamsRef, orderBy('points', 'desc'));

      onSnapshot(gameRef, (snap) => {
        if (!snap.exists()) {
          currentQuestion.textContent = '‚Äî';
          return;
        }
        const ended = !!snap.data().ended;
        if (ended) {
          currentQuestion.textContent = 'Terminado';
          finalReport.classList.remove('hidden');
        }
        const idx = snap.data().currentQuestionIndex;
        currentQuestionIndex = typeof idx === 'number' ? idx : -1;
        if (typeof idx === 'number' && idx >= 0) {
          currentQuestion.textContent = `#${idx + 1}`;
        } else {
          if (!ended) currentQuestion.textContent = 'No iniciada';
        }

        listenAnswersForQuestion(currentQuestionIndex);
      }, (err) => {
        console.error(err);
        currentQuestion.textContent = '‚Äî';
      });

      onSnapshot(teamsQuery, (snap) => {
        registeredTeamsCount = snap.size;
        teamCount.textContent = registeredTeamsCount;
        teamsTable.innerHTML = '';
        snap.forEach((d) => {
          const team = d.data();
          const tr = document.createElement('tr');
          tr.className = 'bg-gray-900 border border-gray-700';

          const tdName = document.createElement('td');
          tdName.className = 'px-4 py-3 rounded-l-xl font-bold';
          tdName.textContent = team.name ?? d.id;

          const tdPoints = document.createElement('td');
          tdPoints.className = 'px-4 py-3 font-extrabold text-indigo-300';
          tdPoints.textContent = String(team.points ?? 0);

          const tdPen = document.createElement('td');
          tdPen.className = 'px-4 py-3 rounded-r-xl text-gray-200';
          tdPen.textContent = String(team.penalties ?? 0);

          tr.appendChild(tdName);
          tr.appendChild(tdPoints);
          tr.appendChild(tdPen);
          teamsTable.appendChild(tr);
        });
      }, (err) => {
        console.error(err);
        teamsTable.innerHTML = '';
        setStatus('Sin permisos para leer equipos (Firestore).');
      });
    }

    async function triggerAutoAdvance() {
      if (autoAdvanceCooldown) return;
      autoAdvanceCooldown = true;
      setStatus('‚è±Ô∏è Avance autom√°tico en 3 segundos...');

      setTimeout(async () => {
        await avanzarPregunta();
        autoAdvanceCooldown = false;
      }, 3000);
    }

    async function avanzarPregunta() {
      setStatus('Avanzando pregunta...');
      try {
        const gameDoc = await getDoc(gameRef);
        let nextIndex = 0;
        if (gameDoc.exists() && typeof gameDoc.data().currentQuestionIndex !== 'undefined') {
          nextIndex = gameDoc.data().currentQuestionIndex + 1;
        }
        if (nextIndex >= preguntas.length) {
          await finishGame();
          return;
        }
        await setDoc(gameRef, { ended: false, endedAt: null, currentQuestionIndex: nextIndex, questionStartedAt: serverTimestamp() }, { merge: true });
        setStatus('Pregunta actualizada.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo avanzar (posible error de permisos en Firestore).');
      }
    }

    btnNextQuestion.addEventListener('click', avanzarPregunta);

    btnEndGame.addEventListener('click', finishGame);

    btnResetGame.addEventListener('click', async () => {
      if (!confirm('¬øReiniciar el juego? Esto pone la pregunta en estado no iniciado.')) return;
      setStatus('Reiniciando juego...');
      try {
        await setDoc(gameRef, { ended: false, endedAt: null, currentQuestionIndex: -1, questionStartedAt: null }, { merge: true });
        setStatus('Juego reiniciado.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo reiniciar (posible error de permisos en Firestore).');
      }
    });

    btnResetPoints.addEventListener('click', async () => {
      if (!confirm('¬øRestablecer puntos y penalizaciones de TODOS los equipos a 0?')) return;
      setStatus('Restableciendo puntos...');
      try {
        const snap = await getDocs(teamsRef);
        const batch = writeBatch(db);
        snap.forEach((d) => {
          batch.update(d.ref, { points: 0, penalties: 0 });
        });
        await batch.commit();
        setStatus('Puntos restablecidos.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo restablecer puntos (posible error de permisos en Firestore).');
      }
    });

    btnDeleteTeams.addEventListener('click', async () => {
      if (!confirm('¬øBORRAR TODOS los equipos y su informaci√≥n?')) return;
      setStatus('Borrando equipos...');
      try {
        const snap = await getDocs(teamsRef);
        const batch = writeBatch(db);
        snap.forEach((d) => {
          batch.delete(d.ref);
        });
        await batch.commit();
        setStatus('Equipos borrados.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo borrar equipos (posible error de permisos en Firestore).');
      }
    });
  </script>
</body>

</html>