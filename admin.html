<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel del LÃ­der</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100 font-sans">
  <div class="max-w-4xl mx-auto p-4 sm:p-8">
    <div class="bg-gray-800 rounded-2xl shadow-xl p-6">
      <h2 class="text-2xl sm:text-3xl font-extrabold">ğŸ‘‘ Panel Admin</h2>
      <p class="text-gray-300 mt-2">Control del juego y equipos.</p>

      <div class="mt-6 flex flex-col sm:flex-row gap-3">
        <input id="clave" placeholder="Clave de admin" class="w-full sm:flex-1 px-4 py-3 rounded-lg bg-gray-900 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="btn-entrar" class="px-5 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 font-bold">Entrar</button>
      </div>

      <p id="admin-status" class="text-sm text-gray-300 mt-3"></p>
    </div>

    <div id="panel" class="hidden mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 bg-gray-800 rounded-2xl shadow-xl p-6">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <h3 class="text-xl font-bold">Equipos</h3>
          <div class="flex gap-2 flex-wrap">
            <button id="btn-reset-points" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-bold">Restablecer puntos</button>
            <button id="btn-reset-game" class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 font-bold">Reiniciar juego</button>
            <button id="btn-delete-teams" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 font-bold">Borrar equipos</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="bg-gray-900 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-xs">Pregunta actual</p>
            <p id="current-question" class="text-lg font-extrabold">â€”</p>
          </div>
          <div class="bg-gray-900 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-xs">Equipos</p>
            <p id="team-count" class="text-lg font-extrabold">0</p>
          </div>
          <div class="bg-gray-900 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-xs">Estado</p>
            <p id="panel-status" class="text-sm text-gray-200">Listo</p>
          </div>
        </div>

        <div class="mt-5 overflow-x-auto">
          <table class="w-full text-left border-separate" style="border-spacing: 0 10px;">
            <thead>
              <tr class="text-gray-400 text-xs">
                <th class="px-4">Equipo</th>
                <th class="px-4">Puntos</th>
                <th class="px-4">Penalizaciones</th>
              </tr>
            </thead>
            <tbody id="teams-table"></tbody>
          </table>
        </div>
      </div>

      <div class="bg-gray-800 rounded-2xl shadow-xl p-6">
        <h3 class="text-xl font-bold">Preguntas (respuestas ocultas)</h3>
        <p class="text-gray-300 text-sm mt-2">Toca el ğŸ‘ï¸ para ver/ocultar la respuesta correcta.</p>
        <div id="questions" class="mt-4 space-y-3"></div>
      </div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      query,
      orderBy,
      onSnapshot,
      getDocs,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC8xL6OM_ff7LqFJj_P87d9wVR-BT8OJsE",
      authDomain: "dinamica-en-tiempo-real.firebaseapp.com",
      projectId: "dinamica-en-tiempo-real",
      storageBucket: "dinamica-en-tiempo-real.firebasestorage.app",
      messagingSenderId: "1096669474654",
      appId: "1:1096669474654:web:0348238823f2a0cbdea9cf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const GAME_ID = "main-game";
    const gameRef = doc(db, `games/${GAME_ID}`);
    const teamsRef = collection(db, `games/${GAME_ID}/teams`);

    const adminRef = doc(db, "config", "admin");

    const panel = document.getElementById('panel');
    const adminStatus = document.getElementById('admin-status');
    const panelStatus = document.getElementById('panel-status');
    const btnEntrar = document.getElementById('btn-entrar');
    const btnResetPoints = document.getElementById('btn-reset-points');
    const btnDeleteTeams = document.getElementById('btn-delete-teams');
    const btnResetGame = document.getElementById('btn-reset-game');
    const teamsTable = document.getElementById('teams-table');
    const teamCount = document.getElementById('team-count');
    const currentQuestion = document.getElementById('current-question');
    const questionsEl = document.getElementById('questions');

    const preguntas = [
      {
        pregunta: "Â¿CuÃ¡l es la cita central del tema La Honra?",
        opciones: ["1 Samuel 2:30", "Proverbios 3:5", "Salmo 23:1"],
        correcta: 0
      },
      {
        pregunta: "Â¿QuÃ© significa honrar a Dios con mi vida?",
        opciones: ["Solo ir a la iglesia", "Vivir como sacrificio agradable a Dios", "Ayunar todos los dÃ­as"],
        correcta: 1
      },
      {
        pregunta: "Â¿CÃ³mo honramos a Dios con nuestra familia?",
        opciones: ["Ignorando responsabilidades", "Guiando a la familia en el camino del SeÃ±or", "Solo orando los domingos"],
        correcta: 1
      },
      {
        pregunta: "Honrar a los padres es...",
        opciones: ["Una sugerencia con recompensa", "El primer mandamiento con promesa", "Una opciÃ³n cultural"],
        correcta: 1
      }
    ];

    function setStatus(text) {
      panelStatus.textContent = text;
    }

    function renderQuestions() {
      questionsEl.innerHTML = '';
      preguntas.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-gray-900 border border-gray-700 rounded-xl p-4';

        const title = document.createElement('div');
        title.className = 'font-bold';
        title.textContent = `${idx + 1}. ${q.pregunta}`;

        const options = document.createElement('div');
        options.className = 'mt-3 space-y-1 text-sm text-gray-200';
        q.opciones.forEach((opt, i) => {
          const line = document.createElement('div');
          line.textContent = `${String.fromCharCode(65 + i)}) ${opt}`;
          options.appendChild(line);
        });

        const footer = document.createElement('div');
        footer.className = 'mt-4 flex items-center justify-between gap-3';

        const answer = document.createElement('div');
        answer.className = 'text-sm text-green-300 hidden';
        answer.textContent = `Correcta: ${String.fromCharCode(65 + q.correcta)} ) ${q.opciones[q.correcta]}`;

        const toggle = document.createElement('button');
        toggle.className = 'px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 border border-gray-700 font-bold';
        toggle.textContent = 'ğŸ‘ï¸';
        toggle.addEventListener('click', () => {
          answer.classList.toggle('hidden');
        });

        footer.appendChild(answer);
        footer.appendChild(toggle);

        card.appendChild(title);
        card.appendChild(options);
        card.appendChild(footer);
        questionsEl.appendChild(card);
      });
    }

    async function entrar() {
      adminStatus.textContent = '';
      const claveIngresada = document.getElementById('clave').value;
      let snap;
      try {
        snap = await getDoc(adminRef);
      } catch (err) {
        console.error(err);
        adminStatus.textContent = 'Error leyendo la clave (posible error de permisos en Firestore).';
        return;
      }

      if (snap.exists() && snap.data().clave === claveIngresada) {
        panel.classList.remove('hidden');
        adminStatus.textContent = 'Acceso concedido.';
        escuchar();
        renderQuestions();
      } else {
        adminStatus.textContent = 'Clave incorrecta.';
      }
    }

    btnEntrar.addEventListener('click', entrar);

    function escuchar() {
      const teamsQuery = query(teamsRef, orderBy('points', 'desc'));

      onSnapshot(gameRef, (snap) => {
        if (!snap.exists()) {
          currentQuestion.textContent = 'â€”';
          return;
        }
        const idx = snap.data().currentQuestionIndex;
        if (typeof idx === 'number' && idx >= 0) {
          currentQuestion.textContent = `#${idx + 1}`;
        } else {
          currentQuestion.textContent = 'No iniciada';
        }
      }, (err) => {
        console.error(err);
        currentQuestion.textContent = 'â€”';
      });

      onSnapshot(teamsQuery, (snap) => {
        teamCount.textContent = snap.size;
        teamsTable.innerHTML = '';
        snap.forEach((d) => {
          const team = d.data();
          const tr = document.createElement('tr');
          tr.className = 'bg-gray-900 border border-gray-700';

          const tdName = document.createElement('td');
          tdName.className = 'px-4 py-3 rounded-l-xl font-bold';
          tdName.textContent = team.name ?? d.id;

          const tdPoints = document.createElement('td');
          tdPoints.className = 'px-4 py-3 font-extrabold text-indigo-300';
          tdPoints.textContent = String(team.points ?? 0);

          const tdPen = document.createElement('td');
          tdPen.className = 'px-4 py-3 rounded-r-xl text-gray-200';
          tdPen.textContent = String(team.penalties ?? 0);

          tr.appendChild(tdName);
          tr.appendChild(tdPoints);
          tr.appendChild(tdPen);
          teamsTable.appendChild(tr);
        });
      }, (err) => {
        console.error(err);
        teamsTable.innerHTML = '';
        setStatus('Sin permisos para leer equipos (Firestore).');
      });
    }

    btnResetGame.addEventListener('click', async () => {
      if (!confirm('Â¿Reiniciar el juego? Esto pone la pregunta en estado no iniciado.')) return;
      setStatus('Reiniciando juego...');
      try {
        await setDoc(gameRef, { currentQuestionIndex: -1 }, { merge: true });
        setStatus('Juego reiniciado.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo reiniciar (posible error de permisos en Firestore).');
      }
    });

    btnResetPoints.addEventListener('click', async () => {
      if (!confirm('Â¿Restablecer puntos y penalizaciones de TODOS los equipos a 0?')) return;
      setStatus('Restableciendo puntos...');
      try {
        const snap = await getDocs(teamsRef);
        const batch = writeBatch(db);
        snap.forEach((d) => {
          batch.update(d.ref, { points: 0, penalties: 0 });
        });
        await batch.commit();
        setStatus('Puntos restablecidos.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo restablecer puntos (posible error de permisos en Firestore).');
      }
    });

    btnDeleteTeams.addEventListener('click', async () => {
      if (!confirm('Â¿BORRAR TODOS los equipos y su informaciÃ³n?')) return;
      setStatus('Borrando equipos...');
      try {
        const snap = await getDocs(teamsRef);
        const batch = writeBatch(db);
        snap.forEach((d) => {
          batch.delete(d.ref);
        });
        await batch.commit();
        setStatus('Equipos borrados.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo borrar equipos (posible error de permisos en Firestore).');
      }
    });
  </script>
</body>
</html>
